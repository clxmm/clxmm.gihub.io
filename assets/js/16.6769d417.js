(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{333:function(s,e,t){"use strict";t.r(e);var a=t(8),r=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"_1-是什么"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-是什么"}},[s._v("#")]),s._v(" 1.是什么")]),s._v(" "),e("p",[e("strong",[s._v("定义")])]),s._v(" "),e("p",[e("strong",[s._v("由于数据量过大")]),s._v("，单个Master复制集难以承担，因此需要对多个复制集进行集群，形成水平扩展每个复制集只负责存储整个数据集的一部分，这就是Redis的集群，其作用是提供在多个Redis节点间共享数据的程序集。")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://redis.io/docs/reference/cluster-spec/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官网"),e("OutboundLink")],1)]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272150294.png"}}),s._v(" "),e("ul",[e("li",[s._v("Redis集群是一个提供在多个Redis节点间共享数据的程序集")]),s._v(" "),e("li",[e("strong",[s._v("Redis集群可以支持多个Master")])])]),s._v(" "),e("h2",{attrs:{id:"_2-能干什么"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-能干什么"}},[s._v("#")]),s._v(" 2.能干什么")]),s._v(" "),e("ul",[e("li",[s._v("Redis集群支持多个Master，每个Master又可以挂载多个Slave")]),s._v(" "),e("li",[s._v("由于Cluster自带Sentinel的故障转移机制，内置了高可用的支持，"),e("strong",[s._v("无需再去使用哨兵功能")])]),s._v(" "),e("li",[s._v("客户端与Redis的节点连接，不再需要连接集群中所有的节点，只需要任意连接集群中的一个可用节点即可")]),s._v(" "),e("li",[e("strong",[s._v("槽位slot")]),s._v("负责分配到各个物理服务节点，由对应的集群来负责维护节点、插槽和数据之间的关系")])]),s._v(" "),e("h2",{attrs:{id:"_3-集群算法-分片-槽位slot"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-集群算法-分片-槽位slot"}},[s._v("#")]),s._v(" 3.集群算法-分片-槽位slot")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://redis.io/docs/latest/operate/oss_and_stack/reference/cluster-spec/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Redis cluster specification | Docs"),e("OutboundLink")],1)]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272156293.png"}}),s._v(" "),e("h3",{attrs:{id:"_3-1-redis集群的槽位slot"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-redis集群的槽位slot"}},[s._v("#")]),s._v(" 3.1 redis集群的槽位slot")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272157307.png",alt:""}})]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272158566.png"}}),s._v(" "),e("h3",{attrs:{id:"_3-2-redis集群的分片"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-redis集群的分片"}},[s._v("#")]),s._v(" 3.2 redis集群的分片")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("分片是什么")]),s._v(" "),e("th",[s._v("使用Redis集群时我们会将存储的数据分散到多台redis机器上，这称为分片。简言之，集群中的每个Redis实例都被认为是整个数据的一个分片。")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("如何找到给定key的分片")]),s._v(" "),e("td",[s._v("为了找到给定key的分片，我们对key进行CRC16(key)算法处理并通过对总分片数量取模。然后，使用确定性哈希函数，这意味着给定的key将多次始终映射到同一个分片，我们可以推断将来读取特定key的位置。")])])])]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272158566.png"}}),s._v(" "),e("h3",{attrs:{id:"_3-3-他两的优势"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-他两的优势"}},[s._v("#")]),s._v(" 3.3 他两的优势")]),s._v(" "),e("p",[e("strong",[s._v("最大优势，方便扩缩容和数据分派查找")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272201206.png",alt:""}})]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272158566.png"}}),s._v(" "),e("h3",{attrs:{id:"_3-4-slot槽位映射-一般业界有3种解决方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-slot槽位映射-一般业界有3种解决方案"}},[s._v("#")]),s._v(" 3.4 slot槽位映射，一般业界有3种解决方案")]),s._v(" "),e("h4",{attrs:{id:"_3-4-1-哈希取余分区"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-1-哈希取余分区"}},[s._v("#")]),s._v(" 3.4.1 哈希取余分区")]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272203799.png"}}),s._v(" "),e("ul",[e("li",[s._v("2亿条记录就是2亿个k,v，我们单机不行必须要分布式多机，假设有3台机器构成一个集群，用户每次读写操作都是根据公式："),e("code",[s._v("hash(key) % N个机器台数，计算出哈希值，用来决定数据映射到哪一个节点上。")])]),s._v(" "),e("li",[s._v("优点:   简单粗暴，直接有效，只需要预估好数据规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求（并维护这些请求的信息），起到负载均衡+分而治之的作用。")]),s._v(" "),e("li",[s._v("缺点：\n"),e("ul",[e("li",[s._v("原来规划好的节点，进行扩容或者缩容就比较麻烦了额，不管扩缩，每次数据变动导致节点有变动，映射关系需要重新进行计算，在服务器个数固定不变时没有问题，如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：Hash(key)/3会变成Hash(key) /?。此时地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控。某个redis机器宕机了，")]),s._v(" "),e("li",[s._v("由于台数数量变化，会导致hash取余全部数据重新洗牌。")])])])]),s._v(" "),e("h4",{attrs:{id:"_3-4-2-一致性哈希算法分区"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-2-一致性哈希算法分区"}},[s._v("#")]),s._v(" 3.4.2 一致性哈希算法分区")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("是什么：")]),s._v(" "),e("p",[s._v("一致性Hash算法背景：　　一致性哈希算法在1997年由麻省理工学院中提出的，设计目标是为了解决")]),s._v(" "),e("p",[e("strong",[s._v("分布式缓存数据变动和映射问题，某个机器宕机了，分母数量改变了，自然取余数不OK了。")])])]),s._v(" "),e("li",[e("p",[s._v("能干什么：")]),s._v(" "),e("ul",[e("li",[s._v("提出一致性Hash解决方案。")]),s._v(" "),e("li",[s._v("目的是当服务器个数发生变动时，")]),s._v(" "),e("li",[s._v("尽量减少影响客户端到服务器的映射关系")])])]),s._v(" "),e("li",[e("p",[s._v("3大步骤⭐")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("算法构建一致性哈希环")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("一致性哈希环。")])]),s._v(" "),e("li",[e("p",[s._v("一致性哈希算法必然有个hash函数并按照算法产生hash值，这个算法的所有可能哈希值会构成一个全量集，这个集合可以成为一个hash空间[0,2^32-1]，这个是一个线性空间，但是在算法中，我们通过适当的逻辑控制将它首尾相连(0 = 2^32),这样让它逻辑上形成了一个环形空间。")])]),s._v(" "),e("li",[e("p",[s._v("它也是按照使用取模的方法，前面笔记介绍的节点取模法是对节点（服务器）的数量进行取模。而一致性Hash算法是对2^32取模，简单来说，一致性Hash算法将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数H的值空间为0-2^32-1（即哈希值是一个32位无符号整形），整个哈希环如下图：整个空间按顺时针方向组织，圆环的正上方的点代表0，0点右侧的第一个点代表1，以此类推，2、3、4、……直到2^32-1，也就是说0点左侧的第一个点代表2^32-1， 0和2^32-1在零点中方向重合，我们把这个由2^32个点组成的圆环称为Hash环。")])])])]),s._v(" "),e("li",[e("p",[s._v("redis服务器IP节点映射")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("将集群中各个IP节点映射到环上的某一个位置。")])]),s._v(" "),e("li",[e("p",[s._v("将各个服务器使用Hash进行一个哈希，具体可以选择服务器的IP或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假如4个节点NodeA、B、C、D，经过IP地址的哈希函数计算(hash(ip))，使用IP地址哈希后在环空间的位置如下：")])])]),s._v(" "),e("h2",{attrs:{id:""}},[e("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")])])]),s._v(" "),e("li",[e("p",[s._v("key落到服务器的落键规则")]),s._v(" "),e("ul",[e("li",[s._v("当我们需要存储一个kv键值对时，首先计算key的hash值，hash(key)，将这个key使用相同的函数Hash计算出哈希值并确定此数据在环上的位置，"),e("strong",[s._v("从此位置沿环顺时针“行走”")]),s._v("，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上。")]),s._v(" "),e("li",[s._v("如我们有Object A、Object B、Object C、Object D四个数据对象，经过哈希计算后，在环空间上的位置如下：根据一致性Hash算法，数据A会被定为到Node A上，B被定为到Node B上，C被定为到Node C上，D被定为到Node D上。")])])])])])]),s._v(" "),e("h4",{attrs:{id:"_3-4-3-哈希槽分区⭐"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-3-哈希槽分区⭐"}},[s._v("#")]),s._v(" 3.4.3 哈希槽分区⭐")]),s._v(" "),e("h5",{attrs:{id:"_1-是什么-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-是什么-2"}},[s._v("#")]),s._v(" 1. 是什么")]),s._v(" "),e("p",[e("strong",[s._v("HASH_SLOT = CRC16(key) mod 16384")])]),s._v(" "),e("ul",[e("li",[s._v("1 为什么出现")])]),s._v(" "),e("p",[s._v("哈希槽实质就是一个数组，数组[0,2^14 -1]形成hash slot空间。")]),s._v(" "),e("ul",[e("li",[s._v("2 能干什么")])]),s._v(" "),e("p",[s._v("解决均匀分配的问题，在数据和节点之间又加入了一层，把这层称为哈希槽（slot），用于管理数据和节点之间的关系，现在就相当于节点上放的是槽，槽里放的是数据。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272222966.png",alt:""}})]),s._v(" "),e("p",[s._v("槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。哈希解决的是映射问题，使用key的哈希值来计算所在的槽，便于数据分配")]),s._v(" "),e("ul",[e("li",[s._v("3 多少个hash槽")])]),s._v(" "),e("p",[s._v("一个集群只能有16384个槽，编号0-16383（0-2^14-1）。这些槽会分配给集群中的所有主节点，分配策略没有要求。")]),s._v(" "),e("p",[s._v("集群会记录节点和槽的对应关系，解决了节点和槽的关系后，接下来就需要对key求哈希值，然后对16384取模，余数是几key就落入对应的槽里。HASH_SLOT = CRC16(key) mod 16384。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。")]),s._v(" "),e("h5",{attrs:{id:"_2-哈希槽计算"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-哈希槽计算"}},[s._v("#")]),s._v(" 2. 哈希槽计算")]),s._v(" "),e("p",[s._v("Redis 集群中内置了 16384 个哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在 Redis 集群中放置一个 key-value时，redis先对key使用crc16算法算出一个结果然后用结果对16384求余数[ CRC16(key) % 16384]，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，也就是映射到某个节点上。如下代码，key之A 、B在Node2， key之C落在Node3上")]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272158566.png"}}),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272225025.png",alt:""}})]),s._v(" "),e("h5",{attrs:{id:"_3-集群的最大槽数是16384-⭐"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-集群的最大槽数是16384-⭐"}},[s._v("#")]),s._v(" 3.集群的最大槽数是16384 ⭐")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("为什么redis集群的最大槽数是16384个？")]),s._v(" "),e("p",[s._v("Redis集群并没有使用一致性hash而是引入了哈希槽的概念。Redis 集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽，集群的每个节点负责一部分hash槽。但为什么哈希槽的数量是16384（2^14）个呢？")]),s._v(" "),e("p",[s._v("CRC16算法产生的hash值有16bit，该算法可以产生2^16=65536个值。换句话说值是分布在0~65535之间，有更大的65536不用为什么只用16384就够？作者在做mod运算的时候，为什么不mod65536，而选择mod16384？ HASH_SLOT = CRC16(key) mod 65536为什么没启用")]),s._v(" "),e("p",[s._v("https://github.com/redis/redis/issues/2576")])]),s._v(" "),e("li",[e("p",[s._v("说明1：正常的心跳数据包带有节点的完整配置，可以用幂等方式用旧的节点替换旧节点，以便更新旧的配置。这意味着它们包含原始节点的插槽配置，该节点使用2k的空间和16k的插槽，但是会使用8k的空间（使用65k的插槽）。同时，由于其他设计折衷，Redis集群不太可能扩展到1000个以上的主节点。因此16k处于正确的范围内，以确保每个主机具有足够的插槽，最多可容纳1000个矩阵，但数量足够少，可以轻松地将插槽配置作为原始位图传播。请注意，在小型群集中，位图将难以压缩，因为当N较小时，位图将设置的slot / N位占设置位的很大百分比。")])]),s._v(" "),e("li",[e("p",[s._v("说明2：")]),s._v(" "),e("ul",[e("li",[s._v("(1)如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大。在消息头中最占空间的是myslots[CLUSTER_SLOTS/8]。 当槽位为65536时，这块的大小是: 65536÷8÷1024=8kb。在消息头中最占空间的是myslots[CLUSTER_SLOTS/8]。 当槽位为16384时，这块的大小是: 16384÷8÷1024=2kb ，因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽。")]),s._v(" "),e("li",[s._v("(2)redis的集群主节点数量基本不可能超过1000个。集群节点越多，心跳包的消息体内携带的数据越多。如果节点过1000个，也会导致网络拥堵。因此redis作者不建议redis cluster节点数量超过1000个。 那么，对于节点数在1000以内的redis cluster集群，16384个槽位够用了。没有必要拓展到65536个。")]),s._v(" "),e("li",[s._v("(3)槽位越小，节点少的情况下，压缩比高，容易传输")]),s._v(" "),e("li",[s._v("Redis主节点的配置信息中它所负责的哈希槽是通过一张bitmap的形式来保存的，在传输过程中会对bitmap进行压缩，但是如果bitmap的填充率slots / N很高的话(N表示节点数)，bitmap的压缩率就很低。 如果节点数很少，而哈希槽数量很多的话，bitmap的压缩率就很低。")])])])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408282236584.png",alt:""}})]),s._v(" "),e("h5",{attrs:{id:"_4-redis集群不保证强一致性-这意味着在特定的条件下-redis集群可能会丢掉一些被系统收到的写入请求命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-redis集群不保证强一致性-这意味着在特定的条件下-redis集群可能会丢掉一些被系统收到的写入请求命令"}},[s._v("#")]),s._v(" 4."),e("strong",[s._v("Redis集群")]),s._v("不保证强一致性，这意味着在特定的条件下，Redis集群可能会丢掉一些被系统收到的写入请求命令")]),s._v(" "),e("h3",{attrs:{id:"_3-5-集群环境搭建⭐"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-集群环境搭建⭐"}},[s._v("#")]),s._v(" 3.5 集群环境搭建⭐")]),s._v(" "),e("h4",{attrs:{id:"_3-5-1-3主3从redis集群配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-1-3主3从redis集群配置"}},[s._v("#")]),s._v(" 3.5.1 3主3从redis集群配置")]),s._v(" "),e("p",[e("strong",[s._v("找3台真实虚拟机，各自新建")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /myredis/cluster\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("新建6个独立的redis实例服务")])]),s._v(" "),e("ul",[e("li",[e("p",[s._v("本次案例设计说明(ip会有变化)")])]),s._v(" "),e("li",[e("p",[e("code",[s._v("IP：192.168.111.175+端口6381/端口6382")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /myredis/cluster/redisCluster6381.conf\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\ndaemonize "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nprotected-mode no\nport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\nlogfile "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/myredis/cluster/cluster6381.log"')]),s._v("\npidfile /myredis/cluster6381.pid\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /myredis/cluster\ndbfilename dump6381.rdb\nappendonly "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nappendfilename "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly6381.aof"')]),s._v("\nrequirepass "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v("\nmasterauth "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v("\n \n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群配置")]),s._v("\ncluster-enabled "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\ncluster-config-file nodes-6381.conf\ncluster-node-timeout "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /myredis/cluster/redisCluster6382.conf\n\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\ndaemonize "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nprotected-mode no\nport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6382")]),s._v("\nlogfile "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/myredis/cluster/cluster6382.log"')]),s._v("\npidfile /myredis/cluster6382.pid\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /myredis/cluster\ndbfilename dump6382.rdb\nappendonly "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nappendfilename "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly6382.aof"')]),s._v("\nrequirepass "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v("\nmasterauth "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v("\n \ncluster-enabled "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\ncluster-config-file nodes-6382.conf\ncluster-node-timeout "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br")])])]),s._v(" "),e("li",[e("p",[e("code",[s._v("IP：192.168.111.172+端口6383/端口6384")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /myredis/cluster/redisCluster6383.conf\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /myredis/cluster/redisCluster6384.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])]),s._v(" "),e("li",[e("p",[e("code",[s._v("IP：192.168.111.174+端口6385/端口6386")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /myredis/cluster/redisCluster6385.conf\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /myredis/cluster/redisCluster6386.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("启动6台redis主机实例")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-server /myredis/cluster/redisCluster6381.conf\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nredis-server /myredis/cluster/redisCluster6386.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])])])]),s._v(" "),e("p",[e("strong",[s._v("通过redis-cli命令为6台机器构建集群关系")])]),s._v(" "),e("p",[e("strong",[s._v("构建主从关系命令")]),s._v("⭐")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("//注意，注意，注意自己的真实IP地址   //注意，注意，注意自己的真实IP地址")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" create --cluster-replicas "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.175:6381 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.175:6382 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.172:6383 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.172:6384 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.174:6385 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.174:6386\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("--cluster-replicas 1 表示为每个master创建一个slave节点")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cli202408302132760.png",alt:""}})]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302131499.png"}})])]),s._v(" "),e("p",[e("strong",[s._v("链接进入6381作为切入点，查看并检验集群状态")])]),s._v(" "),e("ul",[e("li",[e("p",[s._v("链接进入6381作为切入点，查看节点状态")]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302135207.png"}}),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302136336.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("info replication")]),s._v(" "),e("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302137374.png"}})]),s._v(" "),e("li",[e("p",[s._v("cluster info")]),s._v(" "),e("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis202408302138346.png"}})]),s._v(" "),e("li",[e("p",[s._v("cluster nodes")]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302139544.png"}})])]),s._v(" "),e("h4",{attrs:{id:"_3-5-2-3主3从redis集群读写"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-2-3主3从redis集群读写"}},[s._v("#")]),s._v(" 3.5.2 3主3从redis集群读写")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("对6381新增两个key，看看效果如何")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302152773.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("为什么报错")]),s._v(" "),e("p",[s._v("一定注意槽位的范围区间，需要路由到位，路由到位，路由到位，路由到位。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302157829.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("如何解决")]),s._v(" "),e("p",[e("strong",[s._v("加入参数-c，优化路由")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408302200299.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("查看集群信息")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408302201524.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("查看某个key该属于对应的槽位值，CLUSTER KEYSLOT 键名称")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408302202046.png",alt:""}})])])]),s._v(" "),e("h4",{attrs:{id:"_3-5-3主从容错切换迁移案例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-3主从容错切换迁移案例"}},[s._v("#")]),s._v(" 3.5.3主从容错切换迁移案例")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("容错切换迁移")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("主6381和从机切换，先停止主机6381")]),s._v(" "),e("ul",[e("li",[s._v("6381主机停了，对应的真实从机上位")]),s._v(" "),e("li",[s._v("6381作为1号主机分配的从机以实际情况为准，具体是几号机器就是几号")])])]),s._v(" "),e("li",[e("p",[s._v("再次查看集群信息,本次6381主6384从")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312106753.png",alt:""}})]),s._v(" "),e("p",[s._v("6381master假如宕机了，6384是否会上位成为了新的master?")])]),s._v(" "),e("li",[e("p",[s._v("停止主机6381,再次查看集群信息")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408312109447.png",alt:""}})]),s._v(" "),e("p",[s._v("6381宕机了，6384上位成为了新的master。")]),s._v(" "),e("p",[s._v("备注：本次脑图笔记6381为主下面挂从6384。每次案例下面挂的从机以实际情况为准，具体是几号机器就是几号")])]),s._v(" "),e("li",[e("p",[s._v("随后，6381原来的主机回来了，是否会上位？")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("恢复前")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312113943.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("恢复后")]),s._v(" "),e("p",[s._v("6381不会上位并以从节点形式回归")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312113151.png",alt:""}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312114936.png",alt:""}})])])])])])]),s._v(" "),e("li",[e("p",[s._v("集群不保证数据一致性100%OK，一定会有数据丢失情况，")]),s._v(" "),e("ul",[e("li",[s._v("Redis集群不保证强一致性，这意味着在特定的条件下，Redis集群可能会丢掉一些被系统收到的写入请求命令")])])]),s._v(" "),e("li",[e("p",[s._v("手动故障转移 or 节点从属调整该如何处理")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("上面一换后6381、6384主从对调了，和原始设计图不一样了，该如何")])]),s._v(" "),e("li",[e("p",[s._v("重新登陆6381机器")])]),s._v(" "),e("li",[e("p",[s._v("常用命令")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("CLUSTER FAILOVER")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster.png",alt:""}})])])])])])])]),s._v(" "),e("h4",{attrs:{id:"_3-5-4-主从扩容案例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-4-主从扩容案例"}},[s._v("#")]),s._v(" 3.5.4 主从扩容案例")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("新建6387、6388两个服务实例配置文件+新建后启动")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("IP：192.168.111.174+端口6387/端口6388")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /myredis/cluster/redisCluster6387.conf\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\ndaemonize "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nprotected-mode no\nport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6387")]),s._v("\nlogfile "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/myredis/cluster/cluster6387.log"')]),s._v("\npidfile /myredis/cluster6387.pid\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /myredis/cluster\ndbfilename dump6387.rdb\nappendonly "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nappendfilename "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly6387.aof"')]),s._v("\nrequirepass "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v("\nmasterauth "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v("\n\ncluster-enabled "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\ncluster-config-file nodes-6387.conf\ncluster-node-timeout "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /myredis/cluster/redisCluster6388.conf\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\ndaemonize "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nprotected-mode no\nport "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6388")]),s._v("\nlogfile "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/myredis/cluster/cluster6388.log"')]),s._v("\npidfile /myredis/cluster6388.pid\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /myredis/cluster\ndbfilename dump6388.rdb\nappendonly "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nappendfilename "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly6388.aof"')]),s._v("\nrequirepass "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v("\nmasterauth "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v("\n \ncluster-enabled "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\ncluster-config-file nodes-6388.conf\ncluster-node-timeout "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br")])])])])]),s._v(" "),e("li",[e("p",[s._v("启动87/88两个新的节点实例，此时他们自己都是master")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-server /myredis/cluster/redisCluster6387.conf\nredis-server /myredis/cluster/redisCluster6388.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408312136733.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("将新增的6387节点(空槽号)作为master节点加入原集群")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("将新增的6387作为master节点加入原有集群")])]),s._v(" "),e("li",[e("p",[s._v("redis-cli -a 密码 --cluster add-node 自己实际IP地址:6387 自己实际IP地址:6381")])]),s._v(" "),e("li",[e("p",[s._v("6387 就是将要作为master新增节点")])]),s._v(" "),e("li",[e("p",[s._v("6381 就是原来集群节点里面的领路人，相当于6387拜拜6381的码头从而找到组织加入集群")])]),s._v(" "),e("li",[e("p",[s._v("redis-cli -a 111111 --cluster add-node 192.168.111.174:6387 192.168.111.175:6381")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312138740.png",alt:""}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312138358.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("检查集群情况第1次")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" 密码 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" check 真实ip地址:6381\nredis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" check "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.175:6381\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312142084.png"}})]),s._v(" "),e("li",[e("p",[s._v("重新分派槽号(reshard )")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("重新分派槽号")])]),s._v(" "),e("li",[e("p",[s._v("命令:redis-cli -a 密码 --credis-cli -a 密码 --cluster reshard 192.168.111.175:6381luster "),e("strong",[s._v("reshard")]),s._v(" IP地址:端口号")])]),s._v(" "),e("li",[e("p",[s._v("redis-cli -a 密码 --cluster reshard 192.168.111.175:6381")]),s._v(" "),e("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312144601.png"}})])])]),s._v(" "),e("li",[e("p",[s._v("检查集群情况第2次")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("槽号分派说明")]),s._v(" "),e("p",[s._v("为什么6387是3个新的区间，以前的还是连续？")]),s._v(" "),e("p",[s._v("重新分配成本太高，所以前3家各自匀出来一部分，从6381/6383/6385三个旧节点分别匀出1364个坑位给新节点6387")]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312147957.png"}})])])]),s._v(" "),e("li",[e("p",[s._v("为主节点6387分配从节点6388")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("命令：redis-cli -a 密码 --cluster add-node ip:新slave端口 ip:新master端口 --cluster-slave --cluster-master-id 新主机节点ID")])]),s._v(" "),e("li",[e("p",[s._v("redis-cli -a 111111 --cluster add-node 192.168.111.174:6388 192.168.111.174:6387 --cluster-slave --cluster-master-id 4feb6a7ee0ed2b39ff86474cf4189ab2a554a40f-------这个是6387的编号，按照自己实际情况")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312149159.png",alt:""}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312149785.png",alt:""}})])])])]),s._v(" "),e("li",[e("p",[s._v("检查集群情况第3次")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("redis-cli --cluster check 真实ip地址:6381")])]),s._v(" "),e("li",[e("p",[s._v("redis-cli -a 111111 --cluster check 192.168.111.175:6381")]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312150404.png"}})])])])])])]),s._v(" "),e("h4",{attrs:{id:"_3-5-5-主从缩容案例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-5-主从缩容案例"}},[s._v("#")]),s._v(" 3.5.5 主从缩容案例")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("目的：6387和6388下线")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022113697.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("检查集群情况第一次，先获得从节点6388的节点ID")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" 密码 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" check "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.174:6388\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022114038.png"}})]),s._v(" "),e("li",[e("p",[s._v("从集群中将4号从节点6388删除")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("命令：redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" 密码 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" del-node ip:从机端口 从机6388节点ID\nredis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" del-node "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.174:6388 218e7b8b4f81be54ff173e4776b4f4faaf7c13da\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022115605.png",alt:""}})]),s._v(" "),e("p",[s._v("检查一下发现，6388被删除了，只剩下7台机器了。")]),s._v(" "),e("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022116467.png"}})]),s._v(" "),e("li",[e("p",[s._v("将6387的槽号清空，重新分配，本例将清出来的槽号都给6381")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" reshard "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.175:6381\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022120324.png",alt:""}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022120911.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("检查集群情况第二次")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" check "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.175:6381\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("个槽位都指给6381，它变成了8192个槽位，相当于全部都给6381了，不然要输入3次，一锅端\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022121994.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("将6387删除")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("命令：redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" 密码 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" del-node ip:端口 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6387")]),s._v("节点ID\nredis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" del-node "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.174:6387 4feb6a7ee0ed2b39ff86474cf4189ab2a554a40f\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022122676.png",alt:""}})])]),s._v(" "),e("li",[e("p",[s._v("检查集群情况第三次,6387/6388被彻底祛除")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("redis-cli "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("111111")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" check "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.175:6381\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022123649.png",alt:""}})]),s._v(" "),e("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022123307.png"}})])]),s._v(" "),e("h3",{attrs:{id:"_3-6-集群常用操作命令和crc16算法分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-集群常用操作命令和crc16算法分析"}},[s._v("#")]),s._v(" 3.6 集群常用操作命令和CRC16算法分析")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("不在同一个slot槽位下的多键操作支持不好，通识占位符登场")]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022126133.png"}}),s._v(" "),e("p",[s._v("可以通过{}来定义同一个组的概念，使key中{}内相同内容的键值对放到一个slot槽位去，对照下图类似k1k2k3都映射为x，自然槽位一样")]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022129957.png"}})]),s._v(" "),e("li",[e("p",[s._v("Redis集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽。集群的每个节点负责一部分hash槽")])]),s._v(" "),e("li",[e("p",[s._v("常用命令")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("集群是否完整才能对外提供服务")]),s._v(" "),e("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022130965.png"}}),s._v(" "),e("p",[s._v("默认YES，现在集群架构是3主3从的redis cluster由3个master平分16384个slot，每个master的小集群负责1/3的slot，对应一部分数据。cluster-require-full-coverage： 默认值 yes , 即需要集群完整性，方可对外提供服务 通常情况，如果这3个小集群中，任何一个（1主1从）挂了，你这个集群对外可提供的数据只有2/3了， 整个集群是不完整的， redis 默认在这种情况下，是不会对外提供服务的。")]),s._v(" "),e("p",[s._v("如果你的诉求是，集群不完整的话也需要对外提供服务，需要将该参数设置为no ，这样的话你挂了的那个小集群是不行了，但是其他的小集群仍然可以对外提供服务。")])]),s._v(" "),e("li",[e("p",[s._v("CLUSTER COUNTKEYSINSLOT 槽位数字编号")]),s._v(" "),e("ul",[e("li",[s._v("1，该槽位被占用")]),s._v(" "),e("li",[s._v("0，该槽位没占用")])])]),s._v(" "),e("li",[e("p",[s._v("CLUSTER KEYSLOT 键名称")]),s._v(" "),e("ul",[e("li",[s._v("该键应该存在哪个槽位上")])])])])])])])}),[],!1,null,null,null);e.default=r.exports}}]);