(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{373:function(e,s,t){"use strict";t.r(s);var n=t(14),a=Object(n.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h2",{attrs:{id:"_1-是什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-是什么"}},[e._v("#")]),e._v(" 1.是什么")]),e._v(" "),s("p",[e._v("吹哨人巡查监控后台master主机是否故障，如果故障了根据"),s("strong",[e._v("投票数")]),e._v("自动将某一个从库转换为新主库，继续对外服务")]),e._v(" "),s("p",[s("strong",[e._v("作用")])]),e._v(" "),s("p",[s("a",{attrs:{href:"https://redis.io/docs/manual/sentinel/",target:"_blank",rel:"noopener noreferrer"}},[e._v("官网"),s("OutboundLink")],1)]),e._v(" "),s("ul",[s("li",[e._v("1、监控redis运行状态，包括master和slave")]),e._v(" "),s("li",[e._v("2、当master down机，能自动将slave切换成新master")])]),e._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262114659.png"}}),e._v(" "),s("p",[e._v("俗称，无人值守运维")]),e._v(" "),s("h2",{attrs:{id:"_2-能干嘛"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-能干嘛"}},[e._v("#")]),e._v(" 2.能干嘛")]),e._v(" "),s("ul",[s("li",[e._v("主从监控：监控主从redis库运行是否正常")]),e._v(" "),s("li",[e._v("消息通知：哨兵可以将故障转移的结果发送给客户端")]),e._v(" "),s("li",[e._v("故障转移：如果Master异常，则会进行主从切换，将其中一个Slave作为新Master")]),e._v(" "),s("li",[e._v("配置中心：客户端通过连接哨兵来获得当前Redis服务的主节点地址")])]),e._v(" "),s("h2",{attrs:{id:"_3-演示"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-演示"}},[e._v("#")]),e._v(" 3.演示")]),e._v(" "),s("h3",{attrs:{id:"_3-1redis-sentinel架构-前提说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1redis-sentinel架构-前提说明"}},[e._v("#")]),e._v(" 3.1"),s("strong",[e._v("Redis Sentinel架构，前提说明")])]),e._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262119710.png"}}),e._v(" "),s("ul",[s("li",[e._v("3个哨兵:自动监控和维护集群，不存放数据，只是吹哨人")]),e._v(" "),s("li",[e._v("1主2从:用于数据读取和存放")])]),e._v(" "),s("h3",{attrs:{id:"_3-2-具体的步骤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-具体的步骤"}},[e._v("#")]),e._v(" 3.2 具体的步骤")]),e._v(" "),s("ol",[s("li",[s("p",[s("strong",[e._v("/myredis目录下新建或者拷贝sentinel.conf文件，名字绝不能错")])])]),e._v(" "),s("li",[s("p",[e._v("先看看/opt目录下默认的sentinel.conf文件的内容")])]),e._v(" "),s("li",[s("p",[e._v("重点参数项说明")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("bind：服务监听地址，用于客户端连接，默认本机地址")])]),e._v(" "),s("li",[s("p",[e._v("daemonize：是否以后台daemon方式运行")])]),e._v(" "),s("li",[s("p",[e._v("protected-mode：安全保护模式")])]),e._v(" "),s("li",[s("p",[e._v("port：")])]),e._v(" "),s("li",[s("p",[e._v("logfile：")])]),e._v(" "),s("li",[s("p",[e._v("pidfile：pid文件路径")])]),e._v(" "),s("li",[s("p",[e._v("dir：工作目录")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("sentinel monitor <master-name> <ip> <redis-port> <quorum>")])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("sentinel auth-pass <master-name> <password>")])])]),e._v(" "),s("li",[s("p",[e._v("其他：")]),e._v(" "),s("ul",[s("li",[s("p",[s("code",[e._v("sentinel down-after-milliseconds <master-name> <milliseconds>")]),e._v(":指定多少毫秒之后，主节点没有应答哨兵，此时哨兵主观上认为主节点下线")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("sentinel parallel-syncs <master-name> <nums>：")]),e._v(" 表示允许并行同步的slave个数，当Master挂了后，哨兵会选出新的Master，此时，剩余的slave会向新的master发起同步数据")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("sentinel failover-timeout <master-name> <milliseconds>")]),e._v(": 故障转移的超时时间，进行故障转移时，如果超过设置的毫秒，表示故障转移失败")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("sentinel notification-script <master-name> <script-path>")]),e._v(": 配置当某一事件发生时所需要执行的脚本")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("sentinel client-reconfig-script <master-name> <script-path>")]),e._v(": 客户端重新配置主节点参数脚本")])])])])])]),e._v(" "),s("li",[s("p",[e._v("本次案例哨兵sentinel文件通用配置")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("由于机器硬件关系，我们的3个哨兵都同时配置进192.168.111.169同一台机器")])]),e._v(" "),s("li",[s("p",[e._v("sentinel26379.conf")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("bind")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.0")]),e._v(".0.0\ndaemonize "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("yes")]),e._v("\nprotected-mode no\nport "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("26379")]),e._v("\nlogfile "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/myredis/sentinel26379.log"')]),e._v("\npidfile /var/run/redis-sentinel26379.pid\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("dir")]),e._v(" /myredis\nsentinel monitor mymaster "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".111.169 "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("6379")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\nsentinel auth-pass mymaster "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("111111")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br")])])]),e._v(" "),s("li",[s("p",[e._v("sentinel26380.conf")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("bind")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.0")]),e._v(".0.0\ndaemonize "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("yes")]),e._v("\nprotected-mode no\nport "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("26380")]),e._v("\nlogfile "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/myredis/sentinel26380.log"')]),e._v("\npidfile /var/run/redis-sentinel26380.pid\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("dir")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/myredis"')]),e._v("\nsentinel monitor mymaster "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".111.169 "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("6379")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\nsentinel auth-pass mymaster "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("111111")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br")])])]),e._v(" "),s("li",[s("p",[e._v("sentinel26381.conf")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("bind")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.0")]),e._v(".0.0\ndaemonize "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("yes")]),e._v("\nprotected-mode no\nport "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("26381")]),e._v("\nlogfile "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/myredis/sentinel26381.log"')]),e._v("\npidfile /var/run/redis-sentinel26381.pid\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("dir")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/myredis"')]),e._v("\nsentinel monitor mymaster "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".111.169 "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("6379")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\nsentinel auth-pass mymaster "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("111111")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br")])])])])])]),e._v(" "),s("h3",{attrs:{id:"_3-3-先启动一主二从3个redis实例-测试正常的主从复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-先启动一主二从3个redis实例-测试正常的主从复制"}},[e._v("#")]),e._v(" 3.3 先启动一主二从3个redis实例，测试正常的主从复制")]),e._v(" "),s("p",[s("strong",[e._v("架构说明")])]),e._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262135970.png",alt:""}})]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",[e._v("169机器上新建redis6379.conf配置文件，由于要配合本次案例，请设置masterauth项访问密码为111111，不然后续可能报错master_link_status:down")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("172机器上新建redis6380.conf配置文件，设置好replicaof"),s("code",[e._v("<masterip> <masterport>")])])]),e._v(" "),s("tr",[s("td",[e._v("173机器上新建redis6381.conf配置文件，设置好replicaof"),s("code",[e._v("<masterip> <masterport>")])])])])]),e._v(" "),s("p",[s("strong",[e._v("3台不同的虚拟机实例，启动三部真实机器实例并连接")])]),e._v(" "),s("p",[s("code",[e._v("redis-cli -a 111111 -p 6379")])]),e._v(" "),s("h3",{attrs:{id:"_3-4-再启动3个哨兵-完成监控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-再启动3个哨兵-完成监控"}},[e._v("#")]),e._v(" 3.4 再启动3个哨兵，完成监控")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("redis-sentinel sentinel26379.conf --sentinel")])]),e._v(" "),s("li",[s("code",[e._v("redis-sentinel sentinel26380.conf --sentinel")])]),e._v(" "),s("li",[s("code",[e._v("redis-sentinel sentinel26381.conf --sentinel")])])]),e._v(" "),s("h3",{attrs:{id:"_3-5-启动3个哨兵监控后再测试一次主从复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-启动3个哨兵监控后再测试一次主从复制"}},[e._v("#")]),e._v(" 3.5 启动3个哨兵监控后再测试一次主从复制")]),e._v(" "),s("h3",{attrs:{id:"_3-6-原有的master挂了"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-原有的master挂了"}},[e._v("#")]),e._v(" 3.6 原有的master挂了")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("我们自己手动关闭6379服务器，模拟master挂了")])]),e._v(" "),s("li",[s("p",[e._v("问题思考")]),e._v(" "),s("ul",[s("li",[e._v("两台"),s("strong",[e._v("从机")]),e._v("数据是否OK")]),e._v(" "),s("li",[e._v("是否会从剩下的2台机器上选出新的master")]),e._v(" "),s("li",[e._v("之前down机的master机器重启回来，谁将会是新老大？会不会双master冲突？")])])]),e._v(" "),s("li",[s("p",[e._v("答案")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("数据OK")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("两个小问题")])]),e._v(" "),s("li",[s("p",[e._v("了解 Broken Pipe")])])]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",[e._v("认识broken pipe")]),e._v(" "),s("th",[e._v("pipe是管道的意思，管道里面是数据流，通常是从文件或网络套接字读取的数据。当该管道从另一端突然关闭时，会发生数据突然中断，即是broken，对于socket来说，可能是网络被拔出或另一端的进程崩溃")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("解决问题")]),e._v(" "),s("td",[e._v("其实当该异常产生的时候，对于服务端来说，并没有多少影响。因为可能是某个客户端突然中止了进程导致了该错误")])]),e._v(" "),s("tr",[s("td",[e._v("总结 Broken Pipe")]),e._v(" "),s("td",[e._v("这个异常是客户端读取超时关闭了连接,这时候服务器端再向客户端已经断开的连接写数据时就发生了broken pipe异常！")])])])])]),e._v(" "),s("li",[s("p",[e._v("投票新选")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("sentinel26379.log")]),e._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262145950.png"}})]),e._v(" "),s("li",[s("p",[e._v("sentinel26380.log")]),e._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262145703.png"}})]),e._v(" "),s("li",[s("p",[e._v("sentinel26381.log")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262146753.png",alt:""}})])])])]),e._v(" "),s("li",[s("p",[e._v("谁是master，限本次案例")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("6381被选为新master，上位成功")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262148392.png",alt:""}})])]),e._v(" "),s("li",[s("p",[e._v("以前的6379从master降级变成了slave")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262148954.png",alt:""}})])]),e._v(" "),s("li",[s("p",[e._v("6380还是slave，只不过换了个新老大6381(6379变6381)，6380还是slave")])])])])])])]),e._v(" "),s("h3",{attrs:{id:"_3-7-对比配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-对比配置文件"}},[e._v("#")]),e._v(" 3.7 对比配置文件")]),e._v(" "),s("ul",[s("li",[e._v("vim sentinel26379.conf")]),e._v(" "),s("li",[e._v("老master，vim redis6379.conf")]),e._v(" "),s("li",[e._v("新master，vim redis6381.conf")])]),e._v(" "),s("p",[s("strong",[e._v("结论")]),e._v("⭐")]),e._v(" "),s("ul",[s("li",[e._v("文件的内容，在运行期间会被sentinel动态进行更改")]),e._v(" "),s("li",[s("strong",[e._v("Master-Slave切换后，master_redis.conf、slave_redis.conf和sentinel.conf的内容都会发生改变，即master_redis.conf中会多一行slaveof的配置，sentinel.conf的监控目标会随之调换")])])]),e._v(" "),s("h3",{attrs:{id:"_3-8-其它备注"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-其它备注"}},[e._v("#")]),e._v(" 3.8 其它备注")]),e._v(" "),s("ul",[s("li",[e._v("生产都是不同机房不同服务器，很少出现3个哨兵全挂掉的情况")]),e._v(" "),s("li",[e._v("可以同时监控多个master，一行一个")])]),e._v(" "),s("h2",{attrs:{id:"_4哨兵运行流程和选举原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4哨兵运行流程和选举原理"}},[e._v("#")]),e._v(" 4哨兵运行流程和选举原理")]),e._v(" "),s("p",[e._v("当一个主从配置中的master失效之后，sentinel可以选举出一个新的master，用于自动接替原master的工作，主从配置中的其他redis服务器自动指向新的master同步数据。一般建议sentinel采取奇数台，防止某一台sentinel无法连接到master导致误切换")]),e._v(" "),s("p",[s("strong",[e._v("运行流程，故障切换")])]),e._v(" "),s("ul",[s("li",[s("p",[e._v("三个哨兵监控一主二从，正常运行中......")])]),e._v(" "),s("li",[s("p",[e._v("SDown主观下线(Subjectively Down)")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("SDOWN(主观不可用)是"),s("strong",[e._v("单个sentinel自己主观上")]),e._v("检测到的关于master的状态，从sentinel的角度来看，如果发送了PING心跳后，在一定时间内没有收到合法的回复，就达到了SDOWN的条件。")])]),e._v(" "),s("li",[s("p",[e._v("sentinel配置文件中的down-after-milliseconds设置了判断主观下线的时间长度")])]),e._v(" "),s("li",[s("p",[e._v("说明")]),e._v(" "),s("p",[e._v("所谓主观下线（Subjectively Down， 简称 SDOWN）指的是单个Sentinel实例对服务器做出的下线判断，即单个sentinel认为某个服务下线（有可能是接收不到订阅，之间的网络不通等等原因）。主观下线就是说如果服务器在[sentinel down-after-milliseconds]给定的毫秒数之内没有回应PING命令或者返回一个错误消息， 那么这个Sentinel会主观的(单方面的)认为这个master不可以用了，o(╥﹏╥)o")]),e._v(" "),s("p",[s("code",[e._v("sentinel down-after-milliseconds <masterName> <timeout>")]),e._v(" : 表示master被当前sentinel实例认定为失效的间隔时间，这个配置其实就是进行主观下线的一个依据,master在多长时间内一直没有给Sentine返回有效信息，则认定该master主观下线。也就是说如果多久没联系上redis-servevr，认为这个redis-server进入到失效（SDOWN）状态。")])])])]),e._v(" "),s("li",[s("p",[e._v("ODown客观下线(Objectively Down)")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("ODOWN需要一定数量的sentinel，多个哨兵达成一致意见,才能认为一个master客观上已经宕掉")])]),e._v(" "),s("li",[s("p",[e._v("四个参数含义：")]),e._v(" "),s("p",[s("code",[e._v("sentinel monitor mymaster 192.168.111.169 6379 2")])]),e._v(" "),s("p",[e._v("masterName是对某个master+slave组合的一个区分标识(一套sentinel可以监听多组master+slave这样的组合)")]),e._v(" "),s("p",[s("strong",[e._v("quorum这个参数是进行客观下线的一个依据")]),e._v("，法定人数/法定票数,意思是至少有quorum个sentinel认为这个master有故障才会对这个master进行下线以及故障转移。因为有的时候，某个sentinel节点可能因为自身网络原因导致无法连接master，而此时master并没有出现故障，所以这就需要多个sentinel都一致认为该master有问题，才可以进行下一步操作，这就保证了公平性和高可用。")])])])]),e._v(" "),s("li",[s("p",[e._v("选举出领导者哨兵(哨兵中选出兵王)")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("当主节点被判断客观下线以后，各个哨兵节点会进行协商，先选举出一个"),s("strong",[e._v("领导者哨兵节点（兵王）")]),e._v(" 并由该领导者节点，也即被选举出的兵王进行failover（故障迁移）")])]),e._v(" "),s("li",[s("p",[e._v("哨兵领导者，兵王如何选出来的？")]),e._v(" "),s("p",[e._v("Raft算法")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262201812.png",alt:""}})]),e._v(" "),s("p",[e._v("监视该主节点的所有哨兵都有可能被选为领导者，选举使用的算法是Raft算法；Raft算法的基本思路"),s("strong",[e._v("是先到先得")]),e._v("即在一轮选举中，哨兵A向B发送成为领导者的申请，如果B没有同意过其他哨兵，则会同意A成为领导者")])])])]),e._v(" "),s("li",[s("p",[e._v("由兵王开始推动故障切换流程并选出一个新master")]),e._v(" "),s("ul",[s("li",[e._v("新主登基\n"),s("ul",[s("li",[e._v("某个Slave被选中成为新Master")]),e._v(" "),s("li",[e._v("选出新master的规则，剩余slave节点健康前提下")])])]),e._v(" "),s("li",[e._v("群臣俯首\n"),s("ul",[s("li",[e._v("执行slaveof no one命令让选出来的从节点成为新的主节点，并通过slaveof命令让其他节点成为其从节点")]),e._v(" "),s("li",[e._v("Sentinel leader会对选举出的新master执行slaveof no one操作，将其提升为master节点")]),e._v(" "),s("li",[e._v("Sentinel leader向其它slave发送命令，让剩余的slave成为新的master节点的slave")])])]),e._v(" "),s("li",[e._v("旧主拜服\n"),s("ul",[s("li",[e._v("将之前已下线的老master设置为新选出的新master的从节点，当老master重新上线后，它会成为新master的从节点")]),e._v(" "),s("li",[e._v("Sentinel leader会让原来的master降级为slave并恢复正常工作。")])])]),e._v(" "),s("li",[e._v("上述的failover操作均由sentinel自己独自完成，完全无需人工干预。")])])])]),e._v(" "),s("h2",{attrs:{id:"_5-哨兵使用建议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-哨兵使用建议"}},[e._v("#")]),e._v(" 5.哨兵使用建议")]),e._v(" "),s("ul",[s("li",[e._v("哨兵节点的数量应为多个，哨兵本身应该集群，保证高可用")]),e._v(" "),s("li",[e._v("哨兵节点的数量应该是奇数")]),e._v(" "),s("li",[e._v("各个哨兵节点的配置应一致")]),e._v(" "),s("li",[e._v("如果哨兵节点部署在Docker等容器里面，尤其要注意端口的正确映射")]),e._v(" "),s("li",[e._v("哨兵集群+主从复制，并不能保证数据零丢失---"),s("strong",[e._v("承上启下引出集群")])])])])}),[],!1,null,null,null);s.default=a.exports}}]);